name: Validate SQL Execution

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'scripts/doc-validator/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'MatrixOne version to test (leave empty for auto-detect)'
        required: false
        type: string

jobs:
  # Step 1: Detect required versions
  detect-versions:
    name: Detect Required MO Versions
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.detect.outputs.versions }}
      matrix: ${{ steps.detect.outputs.matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect versions from changed files
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with specific version
            echo "versions=[\"${{ inputs.version }}\"]" >> $GITHUB_OUTPUT
            echo "matrix={\"version\":[\"${{ inputs.version }}\"]}" >> $GITHUB_OUTPUT
          else
            # Auto-detect from changed files
            RESULT=$(node ./scripts/doc-validator/detect-versions.js --changed-only)
            VERSIONS=$(echo "$RESULT" | jq -c '.versions')
            echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
            echo "matrix={\"version\":$VERSIONS}" >> $GITHUB_OUTPUT

            echo "ğŸ“‹ Detected versions:"
            echo "$RESULT" | jq '.versions'
          fi

  # Step 2: Test SQL execution for each version
  validate-sql:
    name: SQL Validation (MO ${{ matrix.version }})
    runs-on: ubuntu-latest
    needs: detect-versions
    if: needs.detect-versions.outputs.versions != '[]'

    strategy:
      matrix: ${{ fromJson(needs.detect-versions.outputs.matrix) }}
      fail-fast: false  # Continue testing other versions even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start MatrixOne container
        run: |
          echo "ğŸš€ Starting MatrixOne ${{ matrix.version }}..."
          docker run -d \
            --name mo-test \
            --privileged \
            -p 6001:6001 \
            -e MO_DEBUG_NO_PROXY=1 \
            matrixorigin/matrixone:${{ matrix.version }}

          echo "âœ… Container started, waiting for database to be ready..."
          echo "ğŸ“Š Container resource limits:"
          docker stats --no-stream mo-test

      - name: Install MySQL client
        run: |
          echo "ğŸ“¦ Installing MySQL client..."
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Wait for MatrixOne to be ready
        run: |
          echo "â³ Waiting for MatrixOne ${{ matrix.version }} to be ready..."

          # Check if container is running
          if ! docker ps | grep -q mo-test; then
            echo "âŒ Container is not running!"
            docker ps -a | grep mo-test
            exit 1
          fi

          # Wait up to 5 minutes (100 attempts Ã— 3 seconds)
          for i in {1..100}; do
            # Check MySQL connection from host
            if mysql -h 127.0.0.1 -P 6001 -u root -p111 -e "SELECT 1" &> /dev/null 2>&1; then
              echo "âœ… MatrixOne is ready after $((i * 3)) seconds!"
              mysql -h 127.0.0.1 -P 6001 -u root -p111 -e "SELECT VERSION()"
              exit 0
            fi

            # Print progress every 10 attempts (30 seconds)
            if [ $((i % 10)) -eq 0 ]; then
              echo "[$((i * 3))s] Still waiting... (attempt $i/100)"
              echo "ğŸ“‹ Checking port 6001 status:"
              nc -zv 127.0.0.1 6001 || echo "Port not accessible yet"
            fi

            sleep 3
          done

          echo "âŒ MatrixOne failed to become ready after 5 minutes"
          echo "ğŸ“‹ Full container logs:"
          docker logs mo-test
          exit 1

      - name: Validate SQL execution in changed files
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ” Validating SQL execution with MatrixOne ${{ matrix.version }}"
          npm run validate-docs:execution:changed -- --db-host 127.0.0.1 --db-port 6001 --db-user root --db-password 111

      - name: Validate all documents (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ” Full SQL execution validation with MatrixOne ${{ matrix.version }}"
          npm run validate-docs:execution -- --db-host 127.0.0.1 --db-port 6001 --db-user root --db-password 111

      - name: Show MatrixOne logs on failure
        if: failure()
        run: |
          echo "ğŸ“‹ MatrixOne logs:"
          docker logs mo-test

      - name: Cleanup MatrixOne container
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up MatrixOne container..."
          docker stop mo-test || true
          docker rm mo-test || true